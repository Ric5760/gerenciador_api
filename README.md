# gerenciador_api
Gera apis conforme tabela de api em DB2
WITH QS AS (SELECT hm.CD_MATRICULA,
       hm.CD_COMISSAO_ORIGEM,
       hm.NM_COMISSAO_ORIGEM,
       hm.DT_POSSE AS DT_QS
FROM DATA.HST_MOVIMENTACOES hm 
WHERE hm.DT_POSSE BETWEEN '2022-01-01' AND '2022-07-31' 
     AND hm.CD_COMISSAO_DESTINO = 998 AND hm.CD_COMISSAO_ORIGEM <> 998),
     
VCP AS (SELECT n.CD_MATRICULA,
        n.DT_INICIO AS DT_INICIO_VCP,
       COALESCE(n.DT_FIM,'9999-12-31') AS DT_FIM_VCP,
       n.TX_EVENTO
FROM (SELECT hf.*
FROM DATA.HISTORICO_FUNCIONAL hf 
WHERE hf.SG_TIPO_HISTORICO = 'J'
UNION ALL 
SELECT hi.*
FROM DATA.HISTORICO_FUNC_INAT  hi 
WHERE hi.SG_TIPO_HISTORICO = 'J') n 
INNER JOIN QS q ON q.CD_MATRICULA = n.CD_MATRICULA
WHERE n.TX_EVENTO LIKE 'VANTAGENS DA COMISSAO%' AND n.DT_FIM IS NOT NULL 
AND (	n.DT_INICIO <= '2022-01-01' AND n.DT_FIM>='2023-08-01' 
 OR n.DT_INICIO >= '2022-01-01' AND n.DT_INICIO <= '2023-08-01' AND n.DT_FIM>='2023-08-01' 
 OR n.DT_INICIO <= '2022-01-01' AND n.DT_FIM>='2022-01-01' AND n.DT_FIM <= '2023-08-01' 
 OR n.DT_INICIO >= '2022-01-01' AND n.DT_INICIO <= '2023-08-01' AND  n.DT_FIM>='2022-01-01' AND n.DT_FIM <= '2023-08-01' )),

     
COM_APOS AS (SELECT hm.CD_MATRICULA,
       MAX(hm.DT_POSSE) AS DT_COMISSAO
FROM DATA.HST_MOVIMENTACOES hm 
INNER JOIN QS q ON q.CD_MATRICULA = hm.CD_MATRICULA AND hm.DT_POSSE > q.DT_QS
INNER JOIN VCP v ON v.CD_MATRICULA = hm.CD_MATRICULA AND hm.DT_POSSE BETWEEN v.DT_INICIO_VCP AND v.DT_FIM_VCP
GROUP BY hm.CD_MATRICULA) 

SELECT hm.*
FROM DATA.HST_MOVIMENTACOES hm 
INNER JOIN COM_APOS ca ON ca.CD_MATRICULA = hm.CD_MATRICULA AND hm.DT_POSSE = ca.DT_COMISSAO
WHERE hm.CD_COMISSAO_DESTINO <> 998
